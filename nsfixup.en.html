<!DOCTYPE html><html class="formal-specification anolis" lang=en><head>
<title>Namespace fixup</title>
<link href=http://suika.fam.cx/www/style/html/spec rel=stylesheet>
<link href=http://suika.fam.cx/www/style/def/dom rel=stylesheet>
<link href=#license rel=license>
</head>
<body class=has-abstract>

<div class=header>
<h1 class="no-toc no-num">Namespace fixup</h1>
<h2 class="no-toc no-num" id=manakai-project-note-date>Manakai Project Note 3 January 2013</h2>

<dl class=versions-uri>
<dt>Latest Version</dt>
  <dd><code class=URI>&lt;<a href=http://suika.fam.cx/www/markup/xml/nsfixup>http://suika.fam.cx/www/markup/xml/nsfixup</a>&gt;</code></dd>
<dt>Version History</dt>
  <dd><code class=URI>&lt;<a href=http://suika.fam.cx/gate/cvs/markup/xml/nsfixup-source.en.html>http://suika.fam.cx/gate/cvs/markup/xml/nsfixup-source.en.html</a>&gt;</code></dd>
<dt id=author>Author</dt>
  <dd><a href=http://suika.fam.cx/~wakaba/who? lang=ja rel=author>Wakaba</a>
  <code class=mail>&lt;<a href=mailto:wakaba@suikawiki.org rel=author>wakaba@suikawiki.org</a>&gt;</code></dd>
</dl>

<p class=copyright id=license lang=en><a href=http://creativecommons.org/publicdomain/zero/1.0/ rel=license><img alt=CC0 src=http://i.creativecommons.org/p/zero/1.0/80x15.png></a> To the
extent possible under law, the editor has waived all copyright and
related or neighboring rights to this work.

</p></div>

<div class=section>
<h2 class="no-toc no-num" id=table-of-contents>Table of contents</h2>

<!--begin-toc-->
<ol class=toc>
 <li><a href=#namespace-mappings><span class=secno>1 </span>Namespace mappings</a></li>
 <li><a href=#serialization-of-the-start-tag-of-an-xml-element><span class=secno>2 </span>Serialization of the start tag of an XML element</a></li></ol>
<!--end-toc-->
</div>

<div class=section>
<h2 id=namespace-mappings><span class=secno>1 </span>Namespace mappings</h2>

<p>The <dfn id=concept-nsmap title=concept-nsmap>namespace mapping</dfn> is a data
structure with the following fields:

</p><dl>

<dt><dfn id=concept-nsmap-default title=concept-nsmap-default>Default namespace</dfn>

</dt><dd>Either a namespace URL, <i>null</i>, or <i>missing</i>.  By
default, its value is <i>missing</i>.

</dd><dt><dfn id=concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>Prefix to URL</dfn>

</dt><dd>An ordered list of key/value pairs, where keys are namespace
prefixes and values are namespace URLs or <i>none</i>.  By default,
the set contains two pairs: (<code>xml</code>, <a href=#the-xml-namespace>the XML
namespace</a>) and (<code>xmlns</code>, <a href=#the-xmlns-namespace>the XMLNS
namespace</a>).

</dd></dl>

<p><dfn id=the-xml-namespace>The XML namespace</dfn> is
<code>http://www.w3.org/XML/1998/namespace</code>.

</p><p><dfn id=the-xmlns-namespace>The XMLNS namespace</dfn> is
<code>http://www.w3.org/2000/xmlns/</code>.

</p></div>

<div class=section>
<h2 id=serialization-of-the-start-tag-of-an-xml-element><span class=secno>2 </span>Serialization of the start tag of an XML element</h2>

<p>To <dfn id=serialize>serialize</dfn> the start tag of an <var title="">element</var>, optionally with the <a href=#concept-nsmap title=concept-nsmap>namespace mapping</a> <var title="">nsmap</var>:

</p><ol>

<li>If <var title="">nsmap</var> is not specified, let <var title="">nsmap</var> be a new <a href=#concept-nsmap title=concept-nsmap>namespace
mapping</a>.

</li><li>Let <var title="">attributes</var> be the list containing the <span title=concept-element-attributes>attributes</span> of <var title="">element</var> in same order.

</li><li>For each attribute in <var title="">attributes</var> whose <span title=concept-attr-namespace>namespace</span> is <a href=#the-xmlns-namespace>the XMLNS
namespace</a>, in order:

  <ol>

  <li>If the <span title=concept-attr-local-name>local name</span> of
  the attribute is <code>xml</code>, or if the <span title=concept-attr-value>value</span> of the attribute is <a href=#the-xml-namespace>the
  XML namespace</a> or <a href=#the-xmlns-namespace>the XMLNS namespace</a>, do
  nothing.

  </li><li>Otherwise, if the <span title=concept-attr-local-name>local
  name</span> of the attribute is <code>xmlns</code>,

    <ol>

    <li>If the <span title=concept-attr-value>value</span> of the
    attribute is the empty string, set the <a href=#concept-nsmap-default title=concept-nsmap-default>default namespace</a> of <var title="">nsmap</var> be <i>null</i>.

    </li><li>Otherwise, set the <a href=#concept-nsmap-default title=concept-nsmap-default>default
    namespace</a> of <var title="">nsmap</var> be the <span title=concept-attr-value>value</span> of the attribute.

    </li></ol>

  </li><li>Otherwise:

    <ol>

    <li>Delete any key/value pairs whose key is equal to the <span title=concept-attr-local-name>local name</span> of the attribute
    from the <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to
    URL</a> list of <var title="">nsmap</var>.

    </li><li>If the <span title=concept-attr-value>value</span> of the
    attribute is the empty string, append key/value pair (<span title=concept-attr-local-name>local name</span> of the attribute,
    <i>none</i>) to the <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix
    to URL</a> list of <var title="">nsmap</var>.

    </li><li>Otherwise, append key/value pair (<span title=concept-attr-local-name>local name</span> of the attribute,
    <span title=concept-attr-value>value</span> of the attribute) to
    the <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to URL</a>
    list of <var title="">nsmap</var>.

    </li></ol>

  </li></ol>

</li><li>Let <var title="">namespace URL</var> be the <span title=concept-element-namespace>namespace</span> of <var title="">element</var>.

</li><li>If <var title="">namespace URL</var> is null:

  <ol>

  <li>If the <a href=#concept-nsmap-default title=concept-nsmap-default>default
  namespace</a> of <var title="">nsmap</var> is not <i>null</i>,

    <ol>

    <li>Set the <a href=#concept-nsmap-default title=concept-nsmap-default>default
    namespace</a> of <var title="">nsmap</var> to <i>null</i>.

    </li><li>If <var title="">attributes</var> contains an attribute whose
    <span title=concept-attr-namespace>namespace</span> is <a href=#the-xmlns-namespace>the
    XMLNS namespace</a> and <span title=concept-attr-local-name>local name</span> is
    <code>xmlns</code>,

      <ol>

      <li>If the <span title=concept-attr-value>value</span> of the
      attribute is not the empty string, clone the attribute, set the
      <span title=concept-attr-value>value</span> of the clone to the
      empty string, and replace the attribute by the clone in <var title="">attributes</var>, preserving the order.

      </li></ol>

    </li><li>Otherwise, prepend a new attribute whose <span title=concept-attr-namespace>namespace</span> is <a href=#the-xmlns-namespace>the XMLNS
    namespace</a>, <span title=concept-attr-local-name>local
    name</span> is <code>xmlns</code>, and <span title=concept-attr-value>value</span> is the empty string to <var title="">attributes</var>.

    </li></ol>

  </li><li>Let <var title="">tag name</var> be the <span title=concept-element-local-name>local name</span> of <var title="">element</var>.

  </li></ol>

</li><li>Otherwise, if <var title="">namespace URL</var> is not null:

  <ol>

  <li>Let <var title="">prefix</var> be the <span title=concept-element-prefix>prefix</span> of <var title="">element</var>.

  </li><li>If <var title="">namespace URL</var> is <a href=#the-xml-namespace>the XML
  namespace</a>, let <var title="">prefix</var> be <code>xml</code>.

  </li><li>If <var title="">namespace URL</var> is <a href=#the-xmlns-namespace>the XMLNS
  namespace</a>, let <var title="">prefix</var> be <code>xmlns</code>.

  </li><li>If <var title="">prefix</var> is null and the <a href=#concept-nsmap-default title=concept-nsmap-default>default namespace</a> of <var title="">nsmap</var> is not a namespace URL:

    <ol>

    <li>Set the <a href=#concept-nsmap-default title=concept-nsmap-default>default
    namespace</a> of <var title="">nsmap</var> to <var title="">namespace
    URL</var>.

    </li><li>Prepend a new attribute whose <span title=concept-attr-namespace>namespace</span> is <a href=#the-xmlns-namespace>the XMLNS
    namespace</a>, <span title=concept-attr-local-name>local
    name</span> is <code>xmlns</code>, and <span title=concept-attr-value>value</span> is <var title="">namespace
    URL</var> to <var title="">attributes</var>.

    </li><li>Let <var title="">tag name</var> be the <span title=concept-element-local-name>local name</span> of <var title="">element</var>.

    </li></ol>

  </li><li>Otherwise, if <var title="">prefix</var> is null and the <a href=#concept-nsmap-default title=concept-nsmap-default>default namespace</a> of <var title="">nsmap</var> is equal to <var title="">namespace URL</var>:

    <ol>

    <li>Let <var title="">tag name</var> be the <span title=concept-element-local-name>local name</span> of <var title="">element</var>.

    </li></ol>

  </li><li>Otherwise, if <var title="">prefix</var> is not null and there is
  the key/value pair whose key is <var title="">prefix</var> and value is
  <var title="">namespace URL</var> in the <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to URL</a> list of <var title="">nsmap</var>:

    <ol>

    <li>Let <var title="">tag name</var> be <var title="">prefix</var>,
    followed by a <code>U+003A</code> <code class=charname>COLON</code> character (<code>:</code>), followed
    by the <span title=concept-element-local-name>local name</span> of
    <var title="">element</var>.

    </li></ol>

  </li><li>Otherwise, if <var title="">prefix</var> is not null and there is
  no key/value pair whose key is <var title="">prefix</var> in the <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to URL</a> list of <var title="">nsmap</var>:

    <ol>

    <li>Append key/value pair (<var title="">prefix</var>, <var title="">namespace URL</var>) to the <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to URL</a> list of
    <var title="">nsmap</var>.

    </li><li>Prepend a new attribute whose <span title=concept-attr-namespace>namespace</span> is <a href=#the-xmlns-namespace>the XMLNS
    namespace</a>, <span title=concept-attr-prefix>prefix</span> is
    <code>xmlns</code>, <span title=concept-attr-local-name>local
    name</span> is <var title="">prefix</var>, and <span title=concept-attr-value>value</span> is <var title="">namespace
    URL</var> to <var title="">attributes</var>.
    
    </li><li>Let <var title="">tag name</var> be <var title="">prefix</var>,
    followed by a <code>U+003A</code> <code class=charname>COLON</code> character (<code>:</code>), followed
    by the <span title=concept-element-local-name>local name</span> of
    <var title="">element</var>.

    </li></ol>

  </li><li>Otherwise, if there is the key/value pair whose value is equal
  to <var title="">namespace URL</var> in the <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to URL</a> list of <var title="">nsmap</var>:

    <ol>

    <li>Let <var title="">prefix</var> be the key of the last key/value
    pair whose value is equal to <var title="">namespace URL</var> in the
    <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to URL</a> list
    of <var title="">nsmap</var>.

    </li><li>Let <var title="">tag name</var> be <var title="">prefix</var>,
    followed by a <code>U+003A</code> <code class=charname>COLON</code> character (<code>:</code>), followed
    by the <span title=concept-element-local-name>local name</span> of
    <var title="">element</var>.

    </li></ol>

  </li><li>Otherwise, if the <a href=#concept-nsmap-default title=concept-nsmap-default>default
  namespace</a> of <var title="">nsmap</var> is equal to <var title="">namespace URL</var>:

    <ol>

    <li>Let <var title="">tag name</var> be the <span title=concept-element-local-name>local name</span> of <var title="">element</var>.

    </li></ol>

  </li><li>Otherwise:

    <ol>

    <li>Let <var title="">prefix</var> be <code title="">a<var title="">n</var></code> where <var title="">n</var> is chosen such that
    <var title="">n</var> is the minimum non-negative integer <code title="">a<var title="">n</var></code> is not found as a key of the
    <a href=#concept-nsmap-prefix-to-url title=concept-nsmap-prefix-to-url>prefix to URL</a> list
    of <var title="">nsmap</var>.

    </li><li>Prepend a new attribute whose <span title=concept-attr-namespace>namespace</span> is <a href=#the-xmlns-namespace>the XMLNS
    namespace</a>, <span title=concept-attr-prefix>prefix is
    <code>xmlns</code>, <span title=concept-attr-local-name>local
    name</span> is <var title="">prefix</var>, and <span title=concept-attr-value>value</span> is <var title="">namespace
    URL</var> to <var title="">attributes</var>.

    </span></li><li>Let <var title="">tag name</var> be <var title="">prefix</var>,
    followed by a <code>U+003A</code> <code class=charname>COLON</code> character (<code>:</code>), followed
    by the <span title=concept-element-local-name>local name</span> of
    <var title="">element</var>.

    </li></ol>

  </li></ol>

  </li><li class=ed>XXX

</li></ol>

</div></body></html>